<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrokParseNoteLM - 문서 기반 질의응답</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/query-component.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/processing-animation.css') }}">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- 헤더 -->
        <header class="app-header">
            <div class="logo">
                <h1>Untitled notebook</h1>
            </div>
            <div class="header-actions">
                <button id="present-btn" class="icon-btn" title="데이터 포그리즈">
                    <span class="material-icons">present_to_all</span>
                </button>
                <!-- 기존 버튼 유지 -->
                <button id="add-doc-btn" class="icon-btn add-btn" title="문서 추가" onclick="document.getElementById('upload-modal').classList.remove('hidden'); console.log('Add doc button clicked via inline handler');">
                    <span class="material-icons">add</span>
                </button>
                <!-- 새로운 문서 추가 버튼 - 텍스트 버튼으로 추가 -->
                <button id="new-add-doc-btn" class="primary-btn" style="margin-left: 8px;" onclick="document.getElementById('upload-modal').classList.remove('hidden'); console.log('New add doc button clicked');">문서 추가</button>
                <button id="more-btn" class="icon-btn" title="추가 옵션">
                    <span class="material-icons">more_vert</span>
                </button>
                <button id="settings-btn" class="icon-btn" title="설정">
                    <span class="material-icons">settings</span>
                </button>
                <div class="user-profile">
                    <div class="avatar">K</div>
                </div>
            </div>
        </header>

        <!-- 메인 컨텐츠 -->
        <main class="app-content">
            <!-- 좌측 사이드바 (문서 목록) -->
            <aside class="sidebar left-sidebar">
                <div class="sidebar-header">
                    <h2>출처</h2>
                    <div class="sidebar-actions">
                        <button id="sidebar-add-doc-btn" class="icon-btn add-btn" title="문서 추가" onclick="document.getElementById('upload-modal').classList.remove('hidden'); console.log('Sidebar add doc button clicked');">
                            <span class="material-icons">add</span>
                        </button>
                        <button id="search-btn" class="icon-btn search-btn" title="검색">
                            <span class="material-icons">search</span>
                        </button>
                    </div>
                </div>
                <div class="sidebar-subtitle">
                    <span>모든 소스 선택</span>
                    <input type="checkbox" id="select-all-sources" class="source-checkbox" checked>
                </div>
                <div id="document-list" class="document-list">
                    {% if documents %}
                        {% for doc in documents %}
                            <div class="document-item {% if doc.selected %}selected{% endif %}" data-id="{{ doc.doc_id }}">
                                <div class="doc-checkbox-container">
                                    <input type="checkbox" class="doc-checkbox" data-id="{{ doc.doc_id }}" {% if doc.processed %}checked{% endif %}>
                                </div>
                                <div class="doc-icon">
                                    <span class="material-icons">
                                        {% if doc.doc_type == 'pdf' %}picture_as_pdf{% else %}description{% endif %}
                                    </span>
                                </div>
                                <div class="doc-info">
                                    <div class="doc-title">{{ doc.filename }}</div>
                                    <div class="doc-meta">
                                        <span class="doc-type">{{ doc.doc_type | upper }}</span>
                                        <span class="doc-status {{ 'processed' if doc.processed else 'unprocessed' }}">
                                            {{ '처리됨' if doc.processed else '미처리' }}
                                        </span>
                                    </div>
                                </div>
                                <div class="doc-actions">
                                    <button class="icon-btn delete-btn" data-id="{{ doc.doc_id }}" title="삭제">
                                        <span class="material-icons">delete</span>
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-documents-message">
                            <span class="material-icons">info</span>
                            <p>문서 목록이 비어 있습니다.</p>
                            <p class="empty-hint">왼쪽 상단의 + 버튼을 클릭하여 새 문서를 추가하세요.</p>
                        </div>

                    {% endif %}

                </div>
            </aside>

            <!-- 중앙 컨텐츠 영역 (문서 내용) -->
            <section class="main-content">
                {% if documents and documents|selectattr('selected')|list %}
                <!-- 문서가 선택된 경우 보여줄 내용 -->
                <div class="document-view-header">
                    <div class="document-owl-container">
                        <img class="document-owl" src="https://cdn-icons-png.flaticon.com/512/6855/6855217.png" alt="문서 아이콘">
                    </div>
                    <h1 class="document-title">선택된 문서 제목</h1>
                    <div class="document-actions">
                        <button class="doc-action-btn" title="문서 복사">
                            <span class="material-icons">content_copy</span>
                        </button>
                    </div>
                </div>
                <div class="document-source">소스 보기</div>
                
                <div class="document-content">
                    <p class="content-text">선택된 문서의 내용이 여기에 표시됩니다.</p>
                </div>
                {% else %}
                <!-- 문서가 선택되지 않은 경우 (시작 화면) -->
                <div class="empty-content-message">
                    <div class="document-owl-container" style="margin-bottom: 40px;">
                        <img class="document-owl" src="https://cdn-icons-png.flaticon.com/512/6855/6855217.png" alt="문서 아이콘">
                    </div>
                    <h2 style="margin-bottom: 20px;">문서를 선택하거나 추가하세요</h2>
                    <p>왼쪽 사이드바에서 문서를 선택하거나 + 버튼을 클릭하여 새 문서를 추가하세요.</p>
                </div>
                {% endif %}

                <div class="content-actions">
                    <div class="action-buttons content-action-buttons">
                        <button class="content-action-btn" title="파일 첨부">
                            <span class="material-icons">attach_file</span>
                        </button>
                        <button class="content-action-btn" title="하이라이트">
                            <span class="material-icons">highlight</span>
                        </button>
                        <button class="content-action-btn" title="새로 추가">
                            <span class="material-icons">add_circle_outline</span>
                        </button>
                    </div>
                </div>

                <div class="ai-response-header">
                    <div class="ai-badge">
                        <span class="material-icons">psychology</span>
                        <span>AI 응답</span>
                    </div>
                    <div class="ai-actions">
                        <button class="copy-btn" title="복사">
                            <span class="material-icons">content_copy</span>
                        </button>
                        <button class="save-memo-btn" title="메모/원본 추가">
                            <span class="material-icons">note_add</span>
                        </button>
                    </div>
                </div>

            </section>

            <!-- 우측 사이드바 (AI 질의 응답 기능) -->
            <aside class="sidebar right-sidebar">
                <div class="right-sidebar-header">
                    <h2>AI 문서 질의</h2>
                    <button class="help-btn" title="도움말">
                        <span class="material-icons">help_outline</span>
                    </button>
                </div>
                
                <!-- 질의 컴포넌트 -->
                <div class="query-component">
                  <div class="query-header">
                    <h3>문서 질의</h3>
                    <p class="query-description">선택한 문서에 대한 질문을 입력하세요</p>
                  </div>
                  
                  <div class="query-input-area">
                    <textarea id="question-input" placeholder="문서 내용에 대해 질문하세요..."></textarea>
                    <button class="send-btn">
                      <span class="material-icons">send</span>
                    </button>
                  </div>
                  
                  <div class="query-status-area">
                    <div class="selected-docs-info">
                      <span id="selected-docs-count">0</span> 문서 선택됨
                    </div>
                    <div class="select-all-container">
                      <input type="checkbox" id="select-all-sources">
                      <label for="select-all-sources">모든 문서 선택</label>
                    </div>
                  </div>
                  
                  <div class="response-history-container">
                    <h4>질의 기록</h4>
                    <!-- 질의 기록이 여기에 추가됩니다 -->
                  </div>
                </div>
                
                <!-- AI 제안 질문 -->
                <div class="ai-suggestion-container">
                    <h4>추천 질문</h4>
                    <div class="ai-suggestion">
                        <div class="ai-suggestion-icon">
                            <span class="material-icons">lightbulb</span>
                        </div>
                        <div class="ai-suggestion-text">이 문서들의 핵심 개념을 요약해주세요.</div>
                    </div>
                    <div class="ai-suggestion">
                        <div class="ai-suggestion-icon">
                            <span class="material-icons">lightbulb</span>
                        </div>
                        <div class="ai-suggestion-text">문서에 나오는 중요한 인물들은 누구인가요?</div>
                    </div>
                </div>
            </aside>
        </main>

        <!-- 하단 상태 표시 영역 -->
        <div class="bottom-container">
            <div class="footer-status">선택한 문서를 기반으로 질문해보세요. 오른쪽 질의 컴포넌트를 이용하세요.</div>
        </div>

        <!-- 업로드 진행 상태 모달 -->
        <div id="upload-progress-modal" class="modal hidden">
            <div class="modal-content">
                <div class="progress-icon">
                    <span class="material-icons">cloud_upload</span>
                </div>
                <h3>문서 업로드 중</h3>
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                <p id="upload-status-text">0%</p>
            </div>
        </div>

        <!-- 파일 업로드 모달 - 완전히 새로운 방식 -->
        <div id="upload-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>문서 업로드</h3>
                    <button class="close-modal-btn">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="upload-area" id="modal-dropzone">
                        <div class="upload-icon">
                            <span class="material-icons">cloud_upload</span>
                        </div>
                        <p>문서를 여기에 끌어다 놓거나</p>
                        <div id="browse-options">
                            <!-- 파일 선택 버튼을 div로 감싸서 이벤트 전파를 차단 -->
                            <div id="browse-btn-wrapper">
                                <button type="button" id="modal-browse-btn" class="primary-btn">파일 선택</button>
                            </div>
                        </div>
                    </div>
                    <div class="upload-options">
                        <div class="option-group">
                            <h4>처리 옵션</h4>
                            <div class="checkbox-option">
                                <input type="checkbox" id="auto-process" checked>
                                <label for="auto-process">업로드 후 자동 처리</label>
                            </div>
                        </div>
                    </div>
                    <!-- 은폐한 파일 입력 필드 컨테이너, 사용자 인터랙션 후에만 생성됨 -->
                    <div id="hidden-file-controls" style="display: none; width: 0; height: 0; overflow: hidden;"></div>
                </div>
                <div class="modal-footer">
                    <button class="cancel-btn" onclick="document.getElementById('upload-modal').classList.add('hidden');">취소</button>
                    <button class="confirm-btn" id="confirm-upload-btn" onclick="handleFileUpload()" disabled>업로드</button>
                </div>
                
                <script>
                    // 파일 업로드 처리 함수
                    function handleFileUpload() {
                        const fileInput = document.querySelector('#hidden-file-controls input[type="file"]');
                        if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                            alert('파일을 선택해주세요.');
                            return;
                        }
                        
                        const file = fileInput.files[0];
                        const formData = new FormData();
                        formData.append('file', file);
                        
                        const autoProcess = document.getElementById('auto-process');
                        if (autoProcess && autoProcess.checked) {
                            formData.append('auto_process', 'true');
                        }
                        
                        // 업로드 모달 숨기기
                        document.getElementById('upload-modal').classList.add('hidden');
                        
                        // 서버에 업로드 요청 
                        fetch('/upload', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                console.log('파일 업로드 성공! 처리 시작:', data);
                                
                                // 문서 처리 애니메이션 시작 - 새로운 단순화된 함수 사용
                                const docId = data.document?.id || data.document?.doc_id;
                                const fileName = data.document?.filename || data.document?.name;
                                
                                if (docId) {
                                    console.log('파일 업로드 성공 - 애니메이션 시작:', docId, fileName);
                                    
                                    // 새로운 단순화된 처리 애니메이션 함수 호출
                                    if (typeof window.startSimpleProcessing === 'function') {
                                        window.startSimpleProcessing(docId, fileName);
                                        return; // 처리 완료 - 다음 코드 실행 중단
                                    }
                                    
                                    // 물리적으로 이전 오버레이 제거
                                    const existingOverlay = document.querySelector('.processing-overlay');
                                    if (existingOverlay) {
                                        existingOverlay.remove();
                                    }
                                    
                                    // 전체 화면 오버레이 생성
                                    const overlay = document.createElement('div');
                                    overlay.className = 'processing-overlay';
                                    overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(255,255,255,0.95); z-index:9999; display:flex; align-items:center; justify-content:center;';
                                    
                                    // 처리 컨테이너 생성
                                    const processingContainer = document.createElement('div');
                                    processingContainer.className = 'processing-container';
                                    processingContainer.style.cssText = 'width:90%; max-width:600px; padding:20px; border-radius:8px; background-color:#f9f9f9; box-shadow:0 2px 10px rgba(0,0,0,0.1);';
                                    
                                    // 애니메이션 HTML 구성
                                    processingContainer.innerHTML = `
                                        <div style="display:flex; align-items:center; margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid #eee;">
                                            <div style="width:40px; height:40px; border-radius:50%; background-color:#e8f4fe; display:flex; align-items:center; justify-content:center; margin-right:15px;">
                                                <span class="material-icons" style="color:#2196f3; animation:spin 2s linear infinite;">autorenew</span>
                                            </div>
                                            <h2 style="font-size:18px; font-weight:600; color:#333; margin:0;">문서 처리 중</h2>
                                        </div>
                                        <div style="padding:10px; margin:15px 0; background-color:#f5f5f5; border-radius:4px; text-align:center;">
                                            <strong>처리중인 파일:</strong> ${fileName || '문서'}
                                        </div>
                                        <div class="processing-steps" style="margin-top:20px;">
                                            <div class="processing-step active" id="processing-step-upload" style="display:flex; padding:12px 0; position:relative; opacity:1;">
                                                <div class="step-icon" style="width:40px; height:40px; border-radius:50%; background-color:#e8f4fe; display:flex; align-items:center; justify-content:center; margin-right:15px; position:relative; z-index:2;">
                                                    <span class="material-icons" style="font-size:20px; color:#2196f3;">cloud_upload</span>
                                                </div>
                                                <div style="flex:1;">
                                                    <div style="font-weight:600; margin-bottom:4px; color:#333;">문서 업로드</div>
                                                    <div style="font-size:14px; color:#666;">서버에 문서를 업로드하는 중입니다</div>
                                                </div>
                                            </div>
                                            <div class="processing-step" id="processing-step-extract" style="display:flex; padding:12px 0; position:relative; opacity:0.5;">
                                                <div class="step-icon" style="width:40px; height:40px; border-radius:50%; background-color:#f5f5f5; display:flex; align-items:center; justify-content:center; margin-right:15px; position:relative; z-index:2;">
                                                    <span class="material-icons" style="font-size:20px; color:#757575;">subject</span>
                                                </div>
                                                <div style="flex:1;">
                                                    <div style="font-weight:600; margin-bottom:4px; color:#333;">텍스트 추출</div>
                                                    <div style="font-size:14px; color:#666;">문서에서 텍스트를 추출하는 중입니다</div>
                                                    <div style="height:8px; width:100%; background-color:#f5f5f5; border-radius:4px; overflow:hidden; margin-top:8px;">
                                                        <div id="progress-extract" style="height:100%; background-color:#2196f3; width:0%; transition:width 0.3s ease;"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="processing-step" id="processing-step-image_analysis" style="display:flex; padding:12px 0; position:relative; opacity:0.5;">
                                                <div class="step-icon" style="width:40px; height:40px; border-radius:50%; background-color:#f5f5f5; display:flex; align-items:center; justify-content:center; margin-right:15px; position:relative; z-index:2;">
                                                    <span class="material-icons" style="font-size:20px; color:#757575;">image</span>
                                                </div>
                                                <div style="flex:1;">
                                                    <div style="font-weight:600; margin-bottom:4px; color:#333;">이미지 분석</div>
                                                    <div style="font-size:14px; color:#666;">문서 내 이미지를 분석하는 중입니다</div>
                                                    <div style="height:8px; width:100%; background-color:#f5f5f5; border-radius:4px; overflow:hidden; margin-top:8px;">
                                                        <div id="progress-image_analysis" style="height:100%; background-color:#2196f3; width:0%; transition:width 0.3s ease;"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="processing-step" id="processing-step-summarize" style="display:flex; padding:12px 0; position:relative; opacity:0.5;">
                                                <div class="step-icon" style="width:40px; height:40px; border-radius:50%; background-color:#f5f5f5; display:flex; align-items:center; justify-content:center; margin-right:15px; position:relative; z-index:2;">
                                                    <span class="material-icons" style="font-size:20px; color:#757575;">psychology</span>
                                                </div>
                                                <div style="flex:1;">
                                                    <div style="font-weight:600; margin-bottom:4px; color:#333;">AI 요약 생성</div>
                                                    <div style="font-size:14px; color:#666;">AI가 문서 내용을 분석하고 요약하는 중입니다</div>
                                                    <div style="height:8px; width:100%; background-color:#f5f5f5; border-radius:4px; overflow:hidden; margin-top:8px;">
                                                        <div id="progress-summarize" style="height:100%; background-color:#2196f3; width:0%; transition:width 0.3s ease;"></div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="processing-step" id="processing-step-complete" style="display:flex; padding:12px 0; position:relative; opacity:0.5;">
                                                <div class="step-icon" style="width:40px; height:40px; border-radius:50%; background-color:#f5f5f5; display:flex; align-items:center; justify-content:center; margin-right:15px; position:relative; z-index:2;">
                                                    <span class="material-icons" style="font-size:20px; color:#757575;">check_circle</span>
                                                </div>
                                                <div style="flex:1;">
                                                    <div style="font-weight:600; margin-bottom:4px; color:#333;">처리 완료</div>
                                                    <div style="font-size:14px; color:#666;">문서 처리가 완료되었습니다</div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                    
                                    // 오버레이에 추가
                                    overlay.appendChild(processingContainer);
                                    document.body.appendChild(overlay);
                                    
                                    // 애니메이션 스타일 추가
                                    const style = document.createElement('style');
                                    style.textContent = `
                                        @keyframes spin {
                                            from { transform: rotate(0deg); }
                                            to { transform: rotate(360deg); }
                                        }
                                    `;
                                    document.head.appendChild(style);
                                    
                                    // 처리 진행 애니메이션 시작
                                    setTimeout(() => {
                                        console.log('처리 애니메이션 시작');
                                        simulateDirectProcessing();
                                    }, 500);
                                }
                                
                                // 직접 처리 애니메이션 함수 정의
                                function simulateDirectProcessing() {
                                    console.log('직접 처리 애니메이션 시작 - 시간:', new Date().toLocaleTimeString());
                                    
                                    // 업로드 완료 표시
                                    const uploadStep = document.getElementById('processing-step-upload');
                                    if (uploadStep) {
                                        uploadStep.style.opacity = '1';
                                        uploadStep.querySelector('.step-icon').style.backgroundColor = '#e8f5e9';
                                        uploadStep.querySelector('.material-icons').style.color = '#4caf50';
                                    }
                                    
                                    // 텍스트 추출 단계 시작
                                    setTimeout(() => {
                                        const extractStep = document.getElementById('processing-step-extract');
                                        if (extractStep) {
                                            extractStep.style.opacity = '1';
                                            extractStep.querySelector('.step-icon').style.backgroundColor = '#e8f4fe';
                                            extractStep.querySelector('.material-icons').style.color = '#2196f3';
                                            
                                            // 진행률 애니메이션
                                            const progressBar = document.getElementById('progress-extract');
                                            let progress = 0;
                                            const extractInterval = setInterval(() => {
                                                progress += 5;
                                                if (progressBar) progressBar.style.width = progress + '%';
                                                
                                                if (progress >= 100) {
                                                    clearInterval(extractInterval);
                                                    extractStep.querySelector('.step-icon').style.backgroundColor = '#e8f5e9';
                                                    extractStep.querySelector('.material-icons').style.color = '#4caf50';
                                                    
                                                    // 이미지 분석 단계 시작
                                                    const imageAnalysisStep = document.getElementById('processing-step-image_analysis');
                                                    if (imageAnalysisStep) {
                                                        imageAnalysisStep.style.opacity = '1';
                                                        imageAnalysisStep.querySelector('.step-icon').style.backgroundColor = '#e8f4fe';
                                                        imageAnalysisStep.querySelector('.material-icons').style.color = '#2196f3';
                                                        
                                                        // 이미지 분석 진행률
                                                        const imageProgressBar = document.getElementById('progress-image_analysis');
                                                        let imageProgress = 0;
                                                        const imageInterval = setInterval(() => {
                                                            imageProgress += 7;
                                                            if (imageProgressBar) imageProgressBar.style.width = imageProgress + '%';
                                                            
                                                            if (imageProgress >= 100) {
                                                                clearInterval(imageInterval);
                                                                imageAnalysisStep.querySelector('.step-icon').style.backgroundColor = '#e8f5e9';
                                                                imageAnalysisStep.querySelector('.material-icons').style.color = '#4caf50';
                                                                
                                                                // 요약 단계 시작
                                                                const summarizeStep = document.getElementById('processing-step-summarize');
                                                                if (summarizeStep) {
                                                                    summarizeStep.style.opacity = '1';
                                                                    summarizeStep.querySelector('.step-icon').style.backgroundColor = '#e8f4fe';
                                                                    summarizeStep.querySelector('.material-icons').style.color = '#2196f3';
                                                                    
                                                                    // 요약 진행률
                                                                    const summaryProgressBar = document.getElementById('progress-summarize');
                                                                    let summaryProgress = 0;
                                                                    const summaryInterval = setInterval(() => {
                                                                        summaryProgress += 4;
                                                                        if (summaryProgressBar) summaryProgressBar.style.width = summaryProgress + '%';
                                                                        
                                                                        if (summaryProgress >= 100) {
                                                                            clearInterval(summaryInterval);
                                                                            summarizeStep.querySelector('.step-icon').style.backgroundColor = '#e8f5e9';
                                                                            summarizeStep.querySelector('.material-icons').style.color = '#4caf50';
                                                                            
                                                                            // 완료 단계
                                                                            setTimeout(() => {
                                                                                const completeStep = document.getElementById('processing-step-complete');
                                                                                if (completeStep) {
                                                                                    completeStep.style.opacity = '1';
                                                                                    completeStep.querySelector('.step-icon').style.backgroundColor = '#e8f5e9';
                                                                                    completeStep.querySelector('.material-icons').style.color = '#4caf50';
                                                                                    
                                                                                    // 완료 후 페이지 새로고침 또는 처리된 문서로 이동
                                                                                    setTimeout(() => {
                                                                                        window.location.reload();
                                                                                    }, 2000);
                                                                                }
                                                                            }, 500);
                                                                        }
                                                                    }, 150);
                                                                }
                                                            }
                                                        }, 120);
                                                    }
                                                }
                                            }, 100);
                                        }
                                    }, 1000);                                    
                                }

                                const mainContent = document.querySelector('.main-content');
                                    if (mainContent) {
                                        // 기존 내용 지우기
                                        mainContent.innerHTML = '';
                                        
                                        // 처리 애니메이션 UI 생성
                                        const processingUI = document.createElement('div');
                                        processingUI.className = 'processing-container';
                                        processingUI.innerHTML = `
                                            <div style="padding:10px;margin:15px 0;background-color:#f5f5f5;border-radius:4px;text-align:center;">
                                                <strong>처리중인 파일:</strong> ${fileName || '문서'}
                                            </div>
                                            <div class="processing-steps">
                                                <div class="processing-step active" id="processing-step-upload">
                                                    <div class="step-icon"><span class="material-icons">cloud_upload</span></div>
                                                    <div class="step-content">
                                                        <div class="step-title">문서 업로드</div>
                                                        <div class="step-description">서버에 문서를 업로드하는 중입니다</div>
                                                    </div>
                                                </div>
                                                <div class="processing-step" id="processing-step-extract">
                                                    <div class="step-icon"><span class="material-icons">subject</span></div>
                                                    <div class="step-content">
                                                        <div class="step-title">텍스트 추출</div>
                                                        <div class="step-description">문서에서 텍스트를 추출하는 중입니다</div>
                                                        <div class="progress-indicator"><div class="progress-bar" id="progress-extract" style="width:0%"></div></div>
                                                    </div>
                                                </div>
                                                <div class="processing-step" id="processing-step-image_analysis">
                                                    <div class="step-icon"><span class="material-icons">image</span></div>
                                                    <div class="step-content">
                                                        <div class="step-title">이미지 분석</div>
                                                        <div class="step-description">문서 내 이미지를 분석하는 중입니다</div>
                                                        <div class="progress-indicator"><div class="progress-bar" id="progress-image_analysis" style="width:0%"></div></div>
                                                    </div>
                                                </div>
                                                <div class="processing-step" id="processing-step-summarize">
                                                    <div class="step-icon"><span class="material-icons">psychology</span></div>
                                                    <div class="step-content">
                                                        <div class="step-title">AI 요약 생성</div>
                                                        <div class="step-description">AI가 문서 내용을 분석하고 요약하는 중입니다</div>
                                                        <div class="progress-indicator"><div class="progress-bar" id="progress-summarize" style="width:0%"></div></div>
                                                    </div>
                                                </div>
                                                <div class="processing-step" id="processing-step-complete">
                                                    <div class="step-icon"><span class="material-icons">check_circle</span></div>
                                                    <div class="step-content">
                                                        <div class="step-title">처리 완료</div>
                                                        <div class="step-description">문서 처리가 완료되었습니다</div>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                        mainContent.appendChild(processingUI);
                                        
                                        // 처리 진행 애니메이션 시작
                                        simulateDocumentProcessing();
                                    } else {
                                        console.error('중앙 컨텐츠 영역을 찾을 수 없습니다');
                                        // 애니메이션 함수를 사용하여 처리 시도
                                        if (typeof window.startProcessingAnimation === 'function') {
                                            window.startProcessingAnimation(docId, fileName);
                                        } else {
                                            window.location.reload();
                                        }
                                    }
                                } else {
                                    // document ID가 없으면 페이지 새로고침
                                    console.error('문서 ID를 찾을 수 없습니다');
                                    window.location.reload();
                                
                            }  
                        })
                        .catch(error => {
                            console.error('Upload error:', error);
                            alert(error);
                        });
                    }
                    
                    // 문서 처리 진행을 시뮬레이션하는 함수
                    function simulateDocumentProcessing() {
                        console.log('문서 처리 시뮬레이션 시작 - 시간:', new Date().toLocaleTimeString());
                        console.log('DOM 상태 확인:', {
                            body: document.body,
                            appContainer: document.querySelector('.app-container'),
                            appContent: document.querySelector('.app-content'),
                            mainContent: document.querySelector('.main-content'),
                            sectionMainContent: document.querySelector('section.main-content'),
                            processingSteps: document.querySelectorAll('.processing-step')
                        });
                        
                        // 업로드 단계 완료 표시 (이미 활성화되어 있음)
                        const uploadStep = document.getElementById('processing-step-upload');
                        if (uploadStep) {
                            uploadStep.classList.add('completed');
                        }
                        
                        // 텍스트 추출 단계 시작
                        setTimeout(() => {
                            const extractStep = document.getElementById('processing-step-extract');
                            if (extractStep) {
                                extractStep.classList.add('active');
                                
                                // 진행률 애니메이션
                                const progressBar = document.getElementById('progress-extract');
                                let progress = 0;
                                const extractInterval = setInterval(() => {
                                    progress += 5;
                                    if (progressBar) progressBar.style.width = progress + '%';
                                    
                                    if (progress >= 100) {
                                        clearInterval(extractInterval);
                                        extractStep.classList.add('completed');
                                        
                                        // 이미지 분석 단계 시작
                                        const imageAnalysisStep = document.getElementById('processing-step-image_analysis');
                                        if (imageAnalysisStep) {
                                            imageAnalysisStep.classList.add('active');
                                            
                                            // 이미지 분석 진행률
                                            const imageProgressBar = document.getElementById('progress-image_analysis');
                                            let imageProgress = 0;
                                            const imageInterval = setInterval(() => {
                                                imageProgress += 7;
                                                if (imageProgressBar) imageProgressBar.style.width = imageProgress + '%';
                                                
                                                if (imageProgress >= 100) {
                                                    clearInterval(imageInterval);
                                                    imageAnalysisStep.classList.add('completed');
                                                    
                                                    // 요약 단계 시작
                                                    const summarizeStep = document.getElementById('processing-step-summarize');
                                                    if (summarizeStep) {
                                                        summarizeStep.classList.add('active');
                                                        
                                                        // 요약 진행률
                                                        const summaryProgressBar = document.getElementById('progress-summarize');
                                                        let summaryProgress = 0;
                                                        const summaryInterval = setInterval(() => {
                                                            summaryProgress += 4;
                                                            if (summaryProgressBar) summaryProgressBar.style.width = summaryProgress + '%';
                                                            
                                                            if (summaryProgress >= 100) {
                                                                clearInterval(summaryInterval);
                                                                summarizeStep.classList.add('completed');
                                                                
                                                                // 완료 단계
                                                                setTimeout(() => {
                                                                    const completeStep = document.getElementById('processing-step-complete');
                                                                    if (completeStep) {
                                                                        completeStep.classList.add('active');
                                                                        completeStep.classList.add('completed');
                                                                        
                                                                        // 완료 후 페이지 새로고침 또는 처리된 문서로 이동
                                                                        setTimeout(() => {
                                                                            window.location.reload();
                                                                        }, 2000);
                                                                    }
                                                                }, 500);
                                                            }
                                                        }, 150);
                                                    }
                                                }
                                            }, 120);
                                        }
                                    }
                                }, 100);
                            }
                        }, 1000);
                    }
                </script>
            </div>
        </div>
        
        <div class="footer-status">NotebookLM과 유사하게 구현된 웹 UI가 제공됩니다.</div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/queryEngine.js') }}"></script>
    <script src="{{ url_for('static', filename='js/directClick.js') }}"></script>
    <script src="{{ url_for('static', filename='js/simpleViewer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/simpleDocumentClick.js') }}"></script>
    <script src="{{ url_for('static', filename='js/processing-animation.js') }}"></script>
    <script src="{{ url_for('static', filename='js/simple-processing.js') }}"></script>
    <script src="{{ url_for('static', filename='js/upload-fix.js') }}"></script>
    <script src="{{ url_for('static', filename='js/file-upload.js') }}"></script>
</body>
</html>
