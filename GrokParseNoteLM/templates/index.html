<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GrokParseNoteLM - 문서 기반 질의응답</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/query-component.css') }}">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- 헤더 -->
        <header class="app-header">
            <div class="logo">
                <h1>Untitled notebook</h1>
            </div>
            <div class="header-actions">
                <button id="present-btn" class="icon-btn" title="데이터 포그리즈">
                    <span class="material-icons">present_to_all</span>
                </button>
                <!-- 기존 버튼 유지 -->
                <button id="add-doc-btn" class="icon-btn add-btn" title="문서 추가" onclick="document.getElementById('upload-modal').classList.remove('hidden'); console.log('Add doc button clicked via inline handler');">
                    <span class="material-icons">add</span>
                </button>
                <!-- 새로운 문서 추가 버튼 - 텍스트 버튼으로 추가 -->
                <button id="new-add-doc-btn" class="primary-btn" style="margin-left: 8px;" onclick="document.getElementById('upload-modal').classList.remove('hidden'); console.log('New add doc button clicked');">문서 추가</button>
                <button id="more-btn" class="icon-btn" title="추가 옵션">
                    <span class="material-icons">more_vert</span>
                </button>
                <button id="settings-btn" class="icon-btn" title="설정">
                    <span class="material-icons">settings</span>
                </button>
                <div class="user-profile">
                    <div class="avatar">K</div>
                </div>
            </div>
        </header>

        <!-- 메인 컨텐츠 -->
        <main class="app-content">
            <!-- 좌측 사이드바 (문서 목록) -->
            <aside class="sidebar left-sidebar">
                <div class="sidebar-header">
                    <h2>출처</h2>
                    <div class="sidebar-actions">
                        <button id="sidebar-add-doc-btn" class="icon-btn add-btn" title="문서 추가" onclick="document.getElementById('upload-modal').classList.remove('hidden'); console.log('Sidebar add doc button clicked');">
                            <span class="material-icons">add</span>
                        </button>
                        <button id="search-btn" class="icon-btn search-btn" title="검색">
                            <span class="material-icons">search</span>
                        </button>
                    </div>
                </div>
                <div class="sidebar-subtitle">
                    <span>모든 소스 선택</span>
                    <input type="checkbox" id="select-all-sources" class="source-checkbox" checked>
                </div>
                <div id="document-list" class="document-list">
                    {% if documents %}
                        {% for doc in documents %}
                            <div class="document-item {% if doc.selected %}selected{% endif %}" data-id="{{ doc.doc_id }}">
                                <div class="doc-checkbox-container">
                                    <input type="checkbox" class="doc-checkbox" data-id="{{ doc.doc_id }}" {% if doc.processed %}checked{% endif %}>
                                </div>
                                <div class="doc-icon">
                                    <span class="material-icons">
                                        {% if doc.doc_type == 'pdf' %}picture_as_pdf{% else %}description{% endif %}
                                    </span>
                                </div>
                                <div class="doc-info">
                                    <div class="doc-title">{{ doc.filename }}</div>
                                    <div class="doc-meta">
                                        <span class="doc-type">{{ doc.doc_type | upper }}</span>
                                        <span class="doc-status {{ 'processed' if doc.processed else 'unprocessed' }}">
                                            {{ '처리됨' if doc.processed else '미처리' }}
                                        </span>
                                    </div>
                                </div>
                                <div class="doc-actions">
                                    <button class="icon-btn delete-btn" data-id="{{ doc.doc_id }}" title="삭제">
                                        <span class="material-icons">delete</span>
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-documents-message">
                            <span class="material-icons">info</span>
                            <p>문서 목록이 비어 있습니다.</p>
                            <p class="empty-hint">왼쪽 상단의 + 버튼을 클릭하여 새 문서를 추가하세요.</p>
                        </div>

                    {% endif %}

                </div>
            </aside>

            <!-- 중앙 컨텐츠 영역 (문서 내용) -->
            <section class="main-content">
                {% if documents and documents|selectattr('selected')|list %}
                <!-- 문서가 선택된 경우 보여줄 내용 -->
                <div class="document-view-header">
                    <div class="document-owl-container">
                        <img class="document-owl" src="https://cdn-icons-png.flaticon.com/512/6855/6855217.png" alt="문서 아이콘">
                    </div>
                    <h1 class="document-title">선택된 문서 제목</h1>
                    <div class="document-actions">
                        <button class="doc-action-btn" title="문서 복사">
                            <span class="material-icons">content_copy</span>
                        </button>
                    </div>
                </div>
                <div class="document-source">소스 보기</div>
                
                <div class="document-content">
                    <p class="content-text">선택된 문서의 내용이 여기에 표시됩니다.</p>
                </div>
                {% else %}
                <!-- 문서가 선택되지 않은 경우 (시작 화면) -->
                <div class="empty-content-message">
                    <div class="document-owl-container" style="margin-bottom: 40px;">
                        <img class="document-owl" src="https://cdn-icons-png.flaticon.com/512/6855/6855217.png" alt="문서 아이콘">
                    </div>
                    <h2 style="margin-bottom: 20px;">문서를 선택하거나 추가하세요</h2>
                    <p>왼쪽 사이드바에서 문서를 선택하거나 + 버튼을 클릭하여 새 문서를 추가하세요.</p>
                </div>
                {% endif %}

                <div class="content-actions">
                    <div class="action-buttons content-action-buttons">
                        <button class="content-action-btn" title="파일 첨부">
                            <span class="material-icons">attach_file</span>
                        </button>
                        <button class="content-action-btn" title="하이라이트">
                            <span class="material-icons">highlight</span>
                        </button>
                        <button class="content-action-btn" title="새로 추가">
                            <span class="material-icons">add_circle_outline</span>
                        </button>
                    </div>
                </div>

                <div class="ai-response-header">
                    <div class="ai-badge">
                        <span class="material-icons">psychology</span>
                        <span>AI 응답</span>
                    </div>
                    <div class="ai-actions">
                        <button class="copy-btn" title="복사">
                            <span class="material-icons">content_copy</span>
                        </button>
                        <button class="save-memo-btn" title="메모/원본 추가">
                            <span class="material-icons">note_add</span>
                        </button>
                    </div>
                </div>

            </section>

            <!-- 우측 사이드바 (AI 질의 응답 기능) -->
            <aside class="sidebar right-sidebar">
                <div class="right-sidebar-header">
                    <h2>AI 문서 질의</h2>
                    <button class="help-btn" title="도움말">
                        <span class="material-icons">help_outline</span>
                    </button>
                </div>
                
                <!-- 질의 컴포넌트 -->
                <div class="query-component">
                  <div class="query-header">
                    <h3>문서 질의</h3>
                    <p class="query-description">선택한 문서에 대한 질문을 입력하세요</p>
                  </div>
                  
                  <div class="query-input-area">
                    <textarea id="question-input" placeholder="문서 내용에 대해 질문하세요..."></textarea>
                    <button class="send-btn">
                      <span class="material-icons">send</span>
                    </button>
                  </div>
                  
                  <div class="query-status-area">
                    <div class="selected-docs-info">
                      <span id="selected-docs-count">0</span> 문서 선택됨
                    </div>
                    <div class="select-all-container">
                      <input type="checkbox" id="select-all-sources">
                      <label for="select-all-sources">모든 문서 선택</label>
                    </div>
                  </div>
                  
                  <div class="response-history-container">
                    <h4>질의 기록</h4>
                    <!-- 질의 기록이 여기에 추가됩니다 -->
                  </div>
                </div>
                
                <!-- AI 제안 질문 -->
                <div class="ai-suggestion-container">
                    <h4>추천 질문</h4>
                    <div class="ai-suggestion">
                        <div class="ai-suggestion-icon">
                            <span class="material-icons">lightbulb</span>
                        </div>
                        <div class="ai-suggestion-text">이 문서들의 핵심 개념을 요약해주세요.</div>
                    </div>
                    <div class="ai-suggestion">
                        <div class="ai-suggestion-icon">
                            <span class="material-icons">lightbulb</span>
                        </div>
                        <div class="ai-suggestion-text">문서에 나오는 중요한 인물들은 누구인가요?</div>
                    </div>
                </div>
            </aside>
        </main>

        <!-- 하단 상태 표시 영역 -->
        <div class="bottom-container">
            <div class="footer-status">선택한 문서를 기반으로 질문해보세요. 오른쪽 질의 컴포넌트를 이용하세요.</div>
        </div>

        <!-- 업로드 진행 상태 모달 -->
        <div id="upload-progress-modal" class="modal hidden">
            <div class="modal-content">
                <div class="progress-icon">
                    <span class="material-icons">cloud_upload</span>
                </div>
                <h3>문서 업로드 중</h3>
                <div class="progress-bar">
                    <div class="progress-fill"></div>
                </div>
                <p id="upload-status-text">0%</p>
            </div>
        </div>

        <!-- 파일 업로드 모달 - 완전히 새로운 방식 -->
        <div id="upload-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>문서 업로드</h3>
                    <button class="close-modal-btn">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="upload-area" id="modal-dropzone">
                        <div class="upload-icon">
                            <span class="material-icons">cloud_upload</span>
                        </div>
                        <p>문서를 여기에 끌어다 놓거나</p>
                        <div id="browse-options">
                            <!-- 파일 선택 버튼을 div로 감싸서 이벤트 전파를 차단 -->
                            <div id="browse-btn-wrapper">
                                <button type="button" id="modal-browse-btn" class="primary-btn">파일 선택</button>
                            </div>
                        </div>
                    </div>
                    <div class="upload-options">
                        <div class="option-group">
                            <h4>처리 옵션</h4>
                            <div class="checkbox-option">
                                <input type="checkbox" id="auto-process" checked>
                                <label for="auto-process">업로드 후 자동 처리</label>
                            </div>
                        </div>
                    </div>
                    <!-- 은폐한 파일 입력 필드 컨테이너, 사용자 인터랙션 후에만 생성됨 -->
                    <div id="hidden-file-controls" style="display: none; width: 0; height: 0; overflow: hidden;"></div>
                </div>
                <div class="modal-footer">
                    <button class="cancel-btn" onclick="document.getElementById('upload-modal').classList.add('hidden');">취소</button>
                    <button class="confirm-btn" id="confirm-upload-btn" onclick="handleFileUpload()" disabled>업로드</button>
                </div>
                
                <script>
                    // 파일 업로드 처리 함수
                    function handleFileUpload() {
                        const fileInput = document.querySelector('#hidden-file-controls input[type="file"]');
                        if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                            alert('파일을 선택해주세요.');
                            return;
                        }
                        
                        const file = fileInput.files[0];
                        const formData = new FormData();
                        formData.append('file', file);
                        
                        const autoProcess = document.getElementById('auto-process');
                        if (autoProcess && autoProcess.checked) {
                            formData.append('auto_process', 'true');
                        }
                        
                        // 업로드 모달 숨기기
                        document.getElementById('upload-modal').classList.add('hidden');
                        
                        // 서버에 업로드 요청 
                        fetch('/upload', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                alert('파일 업로드 성공!');
                                // 페이지 새로고침
                                window.location.reload();
                            } else {
                                alert('업로드 실패: ' + (data.message || '오류가 발생했습니다.'));
                            }
                        })
                        .catch(error => {
                            console.error('Upload error:', error);
                            alert('업로드 중 오류가 발생했습니다.');
                        });
                    }
                </script>
            </div>
        </div>
        
        <div class="footer-status">NotebookLM과 유사하게 구현된 웹 UI가 제공됩니다.</div>
    </div>

    <script src="{{ url_for('static', filename='js/processing.js') }}"></script>
    <script src="{{ url_for('static', filename='js/queryEngine.js') }}"></script>
    <script src="{{ url_for('static', filename='js/simpleDocumentClick.js') }}"></script>
    <script src="{{ url_for('static', filename='js/file-upload.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script src="{{ url_for('static', filename='js/upload-fix.js') }}"></script>
</body>
</html>
